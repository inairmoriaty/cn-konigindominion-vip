<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>KÖNIGIN - 十七的房间</title>

  <link rel="stylesheet" href="/style/footer.css">
  <link rel="stylesheet" href="/style/mobile.css">

  <style>
    :root{
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --vh: 1vh;
    }
    @supports (height: 100svh){
      :root{ --vh: 1svh; }
    }

    /* ✅ 允许页面自然滚动，避免锁死 */
    html, body{
      margin:0; padding:0;
      width:100%;
      min-height: calc(var(--vh) * 100);
      background:#191919;
      overflow-x:hidden;       /* 只禁水平滚动 */
      overflow-y:auto;         /* 允许竖向滚动 */
    }

    /* ✅ 容器用 min-height，别用固定 100vh/overflow:hidden */
    .app-frame{
      width:100%;
      max-width:1440px;
      min-height: calc(var(--vh) * 100);
      position:relative;
      margin:0 auto;
      box-shadow:none;
      background:#191919;
      border-radius:0;
      overflow:visible;        /* 让内部元素能显示/滚动 */
      padding-top: var(--safe-top);
      padding-bottom: var(--safe-bottom); /* 底栏额外留白由 footer.css 统一处理 */
      box-sizing:border-box;
    }

    /* 背景仍可用绝对定位，不影响滚动 */
    .bg-static{
      position:absolute; left:0; top:0;
      width:100%; height:100%;
      background-image: url('../../img/guest/17_bg.png');
      background-size:cover;
      background-position:center;
      background-repeat:no-repeat;
      z-index:1;
    }

    /* 门牌 */
    .guest-title{
      position:absolute;
      top:-3%; left:50%;
      transform: translateX(-50%);
      width:750px; height:300px;
      background: url('../../img/guest/17_door.png') center/contain no-repeat;
      z-index:2; pointer-events:none;
    }

    /* 交互按钮（默认闪烁） */
    .interaction-btn{
      position:absolute;
      z-index:10;
      top:58%;
      left:45%;
      transform:translate(-50%,-50%);
      cursor:pointer;
    }
    .interaction-btn img{
      width: clamp(56px, 12vmin, 100px);
      height: clamp(56px, 12vmin, 100px);
      display:block;
      pointer-events:auto;
      transition: transform .2s ease, filter .2s ease;
    }
    .interaction-btn:hover img{ filter:brightness(1.2); transform:scale(1.05); }
    .interaction-btn:active img{ filter:brightness(.85); transform:scale(.95); }

    .interaction-btn.blink img{
      animation: btn-blink 1.2s infinite ease-in-out;
    }
    @keyframes btn-blink {
      0%   { opacity: 1; filter: drop-shadow(0 0 0px #fff6) brightness(1); }
      40%  { opacity: .6; filter: drop-shadow(0 0 8px #e6f3ff) brightness(1.3);}
      60%  { opacity: 1; filter: drop-shadow(0 0 16px #b5e2ff) brightness(1.5);}
      100% { opacity: 1; filter: drop-shadow(0 0 0px #fff6) brightness(1); }
    }

    /* 底部遮罩（位于底栏下层） */
    .bottom-mask{
      position:absolute; left:0; bottom:0; width:100%;
      height:92px; background:#191919; z-index:3; pointer-events:none;
    }

    @media (max-width:768px){
      .bg-static{ background-size:cover; background-position:center; }
    }

    /* ====== 客单滚轮选项 ====== */
    .guest-list-wrapper{
      position: absolute;
      left: 53%;
      transform: translateX(-50%);
      top: 22%;
      width: 180px;

      /* 统一可视高度为 3~6 行 */
      height: auto;

      z-index: 20;
      display: flex;
      align-items: stretch;
      gap: 12px;

      opacity: 0;
      visibility: hidden;
      pointer-events: none;              /* 隐藏时不抢事件 */
      transition: opacity .3s ease, visibility .3s ease;
      will-change: opacity, transform;
    }
    .guest-list-wrapper.show{
      opacity:1;
      visibility:visible;
      pointer-events:auto;               /* 显示时可点 */
    }

    .guest-list{
      position: relative;
      flex: 1 1 auto;
      height: 100%;
      overflow: hidden;

      /* 上下渐隐（36px 边缘） */
      -webkit-mask-image: linear-gradient(to bottom,
        rgba(0,0,0,0) 0,
        rgba(0,0,0,1) 36px,
        rgba(0,0,0,1) calc(100% - 36px),
        rgba(0,0,0,0) 100%);
      mask-image: linear-gradient(to bottom,
        rgba(0,0,0,0) 0,
        rgba(0,0,0,1) 36px,
        rgba(0,0,0,1) calc(100% - 36px),
        rgba(0,0,0,0) 100%);
    }

    /* ✅ 视口高度自适应（3～6行），用原生滚动+吸附 */
    .guest-list-viewport{
      height: clamp(216px, 32vh, 432px);      /* 3~6 行可见 */
      overflow-y: auto;
      padding-right: 8px;
      scrollbar-width: none;

      -webkit-overflow-scrolling: touch;      /* iOS 惯性滚动 */
      overscroll-behavior: contain;           /* 防父级联动 */
      touch-action: pan-y;                    /* 明确纵向滚动 */

      scroll-snap-type: y mandatory;          /* 吸附到行中心 */
    }
    .guest-list-viewport::-webkit-scrollbar{ display:none; }

    .guest-item{
      width: 100%;
      box-sizing: border-box;

      height: 48px;                /* 元素本体 */
      padding: 0 10px;
      margin: 12px 0;              /* 上下各 12，总行距 72 */
      display: flex;
      align-items: center;
      justify-content: center;

      color: #fff;
      font-size: 16px;
      font-family: "SimSun","宋体",serif;
      letter-spacing: .5px;
      user-select: none;
      cursor: pointer;

      background: linear-gradient(180deg, #5a5a5a 0%, #4a4a4a 45%, #414141 100%);
      border: 1px solid #696969;
      border-radius: 14px;
      box-shadow:
        inset 0 1px 0 rgba(255,255,255,.12),
        inset 0 -2px 4px rgba(0,0,0,.35),
        0 2px 10px rgba(0,0,0,.25);
      transition: transform .15s ease, background .2s ease;

      scroll-snap-align: center;   /* 与吸附滚动配合 */
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      will-change: transform;
    }
    .guest-item:hover{
      background: linear-gradient(180deg, #6a6a6a 0%, #5a5a5a 45%, #515151 100%);
      transform: scale(1.02);
    }
    .guest-item:active{ transform: scale(0.98); }
  </style>
</head>
<body>
  <div class="app-frame">
    <div class="bg-static"></div>
    <div class="guest-title"></div>

    <!-- 交互按钮：点击展开/收起滚轮 -->
    <a href="#" class="interaction-btn blink" title="Interaction" id="interactionButton">
      <img src="../../img/default btn.png" alt="Interaction Button"/>
    </a>

    <!-- 客单滚轮选项（默认隐藏） -->
    <div class="guest-list-wrapper" id="guestList">
      <div class="guest-list">
        <div class="guest-list-viewport" id="guestViewport">
          <div class="guest-items-container" id="guestItemsContainer">
            <div class="guest-item" data-article="paradise/catalog.html">天堂的彼端</div>
            <div class="guest-item" data-article="seeking/catalog.html">seeking</div>
            <div class="guest-item" data-article="infirmary1.html">医闹（上）</div>
            <div class="guest-item" data-article="infirmary2.html">医闹（下）</div>
            <div class="guest-item" data-article="zombie.html">血肉重组</div>
            <!-- 这里可以继续按相同格式添加更多条目 -->
          </div>
        </div>
      </div>
    </div>

    <div class="bottom-mask"></div>
  </div>

  <!-- Footer自动插入点 -->
  <div id="footer-placeholder"></div>
  <script src="../../js/mobile-optimization.js"></script>
  <script src="../../js/footer.js"></script>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    console.log('seventeen page loaded');

    const btn      = document.getElementById('interactionButton');
    const panel    = document.getElementById('guestList');             // .guest-list-wrapper
    const viewport = document.getElementById('guestViewport')
                   || panel?.querySelector('.guest-list-viewport');

    // 初始隐藏且不吃事件（与 CSS 保持一致）
    if (panel) {
      panel.classList.remove('show');
      panel.style.pointerEvents = 'none';
    }

    function showPanel(){
      if (!panel) return;
      panel.classList.add('show');
      panel.style.pointerEvents = 'auto';
    }
    function hidePanel(){
      if (!panel) return;
      panel.classList.remove('show');
      panel.style.pointerEvents = 'none';
    }
    function togglePanel(){
      if (!panel) return;
      panel.classList.contains('show') ? hidePanel() : showPanel();
    }

    // ✅ 统一 pointerup（避免 click/touchend 双触发）
    if (btn) {
      const fresh = btn.cloneNode(true);      // 清理旧事件，防重复绑定
      btn.replaceWith(fresh);
      fresh.addEventListener('pointerup', (e) => {
        e.preventDefault();
        e.stopPropagation();
        togglePanel();
      }, { passive:false });
    } else {
      console.warn('interaction button not found');
    }

    // 点击空白收起
    document.addEventListener('pointerup', (e) => {
      if (!panel || !panel.classList.contains('show')) return;
      const nowBtn = document.getElementById('interactionButton') || document.querySelector('.interaction-btn');
      const onBtn   = (nowBtn && (nowBtn === e.target || nowBtn.contains(e.target)));
      const onPanel = panel.contains(e.target);
      if (!onBtn && !onPanel) hidePanel();
    }, { passive:true });

    // ====== 列表项轻点跳转 / 滚动不跳 ======
    const TAP_MOVE_MAX = 8;     // 最大位移（px）
    const TAP_TIME_MAX = 350;   // 最大时长（ms）
    let startX = 0, startY = 0, startT = 0, moved = false, downTarget = null;

    if (viewport) {
      // 滚动相关优化
      viewport.style.webkitOverflowScrolling = 'touch';
      viewport.style.overscrollBehavior = 'contain';
      viewport.style.touchAction = 'pan-y';

      viewport.addEventListener('pointerdown', (e) => {
        const item = e.target.closest('.guest-item');
        startX = e.clientX;
        startY = e.clientY;
        startT = Date.now();
        moved  = false;
        downTarget = item;
      }, { passive:true });

      viewport.addEventListener('pointermove', (e) => {
        if (!downTarget || moved) return;
        if (Math.abs(e.clientX - startX) > TAP_MOVE_MAX ||
            Math.abs(e.clientY - startY) > TAP_MOVE_MAX) {
          moved = true;   // 认定为“滚动”
        }
      }, { passive:true });

      viewport.addEventListener('pointerup', (e) => {
        const item = e.target.closest('.guest-item');
        const dt = Date.now() - startT;

        // 非按下的那个元素、滑动、或时间过长，都不处理
        if (!item || item !== downTarget || moved || dt > TAP_TIME_MAX) {
          downTarget = null;
          return;
        }

        e.preventDefault();
        e.stopPropagation();

        // 读取 data-article 或 data-link
        const article = item.getAttribute('data-article');
        const link    = item.getAttribute('data-link');

        // 保存会话（可保留）
        try {
          const s = { timestamp: Date.now(), expiry: Date.now() + 30*60*1000 };
          sessionStorage.setItem('article_hierarchy_session', JSON.stringify(s));
        } catch {}

        if (article) {
          if (article === 'paradise/catalog.html') {
            window.location.href = '/article/private/paradise/catalog.html';
          } else if (article === 'seeking/catalog.html') {
            window.location.href = '/article/private/seeking/catalog.html';
          } else {
            window.location.href = `../../article/private/${article}`;
          }
        } else if (link) {
          window.location.href = link;
        } else {
          console.warn('该项未配置跳转：需要 data-article 或 data-link', item);
        }

        downTarget = null;
      }, { passive:false });
    } else {
      console.warn('guest viewport not found');
    }
  });
  </script>
</body>
</html>