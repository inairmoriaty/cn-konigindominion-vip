<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=390, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>KÖNIGIN - 通知</title>
  <link rel="stylesheet" href="../style/home.css" />
  <link rel="stylesheet" href="../style/footer.css" />
  <link rel="stylesheet" href="../style/mobile.css" />

  <style>
    :root{
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --card-bg: #1e1e1e;
      --card-border: #2a2a2a;
      --text-main: #fafafa;
      --text-sub: #b8b8b8;
      --accent: #8aa4ff;
    }

    html, body {
      margin: 0; padding: 0;
      width: 100vw; min-height: 100vh;
      background: #191919;
      color: var(--text-main);
      overflow-x: hidden;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    .app-frame{
      width: 100%;
      height: 100vh;
      max-width: 1440px;
      margin: 0 auto;
      position: relative;
      box-sizing: border-box;
      padding-top: var(--safe-top);
      overflow-y: auto; /* 列表滚动 */
      background: #191919;
    }

    .page-header{
      position: sticky;
      top: 0;
      z-index: 5;
      background: linear-gradient(#191919, rgba(25,25,25,.6));
      backdrop-filter: blur(6px);
      padding: 18px 20px 10px;
    }
    .page-title{
      font-size: 20px;
      font-weight: 800;
    }
    .page-sub{
      margin-top: 6px;
      font-size: 13px;
      color: var(--text-sub);
    }

    /* 列表容器 */
    .notice-list{
      padding: 12px 14px 24px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* 日期分组标题 */
    .date-sep{
      padding: 10px 6px 6px;
      font-size: 12px;
      color: var(--text-sub);
      letter-spacing: .3px;
    }

    /* 通知卡片（iOS 风格） */
    .notice{
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: 16px;
      box-shadow: 0 6px 18px rgba(0,0,0,.28);
      overflow: hidden;
    }

    /* 标题行（可点击） */
    .notice-head{
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      gap: 10px;
      padding: 14px 14px 12px 14px;
      cursor: pointer;
      user-select: none;
    }
    .notice-title{
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .notice-title .t-line{
      display: flex;
      gap: 8px;
      align-items: baseline;
      flex-wrap: wrap;
    }
    .notice-title .title{
      font-size: 15px;
      font-weight: 700;
      line-height: 1.2;
    }
    .notice-title .date{
      font-size: 12px; color: var(--text-sub);
    }
    .notice-title .summary{
      font-size: 13px; color: var(--text-sub);
      line-height: 1.5;
    }

    /* 右侧小箭头 */
    .chevron{
      width: 22px; height: 22px;
      display: inline-flex; align-items: center; justify-content: center;
      transition: transform .22s ease;
      opacity: .9;
    }
    .notice.open .chevron{ transform: rotate(90deg); }

    /* 内容区（折叠面板） */
    .notice-body{
      max-height: 0;
      overflow: hidden;
      transition: max-height .28s ease;
      border-top: 1px solid var(--card-border);
    }
    .notice.open .notice-body{
      /* 展开时会由 JS 动态设置 max-height 以实现动画 */
    }
    .notice-content{
      padding: 12px 14px 14px;
      font-size: 14px;
      line-height: 1.7;
      color: #e9e9e9;
    }
    .notice-content p{ margin: 0 0 10px; }
    .notice-content a{
      color: var(--accent);
      text-decoration: none;
    }
    .notice-content a:hover{ text-decoration: underline; }

    /* 更新条目列表 */
    .changes{
      margin: 8px 0 4px 0;
      padding-left: 18px;
    }
    .changes li{
      margin: 4px 0;
    }

    .badge{
      display: inline-block;
      padding: 2px 6px;
      border-radius: 6px;
      background: #2a2a2a;
      color: #cfcfcf;
      font-size: 12px;
    }

    /* 底部遮罩，避免被底部导航覆盖 */
    .bottom-mask{
      position: sticky;
      bottom: 0;
      height: 92px;
      background: linear-gradient(transparent, #191919 60%);
      pointer-events: none;
      z-index: 3;
    }

    @media (max-width: 420px){
      .notice-title .title{ font-size: 14px; }
      .notice-title .summary{ font-size: 12px; }
    }
  </style>
</head>
<body>
  <div class="page-container">
  <div class="app-frame">
    <header class="page-header">
      <div class="page-title">通知 / Notifications</div>
      <div class="page-sub">点按卡片可展开查看每次更新的详细说明与入口链接</div>
    </header>

    <main class="notice-list" id="noticeList">
      <!-- 列表由脚本渲染 -->
    </main>

    <div class="bottom-mask"></div>
  </div>
  </div>
  <!-- Footer 自动插入 -->
  <div id="footer-placeholder"></div>
  <script src="../js/footer.js"></script>
<!-- 放在有“通知”按钮的页面，建议加 defer -->
<script defer src="/js/notice-badge.js"></script>

  <script>
    (function(){
      const listEl = document.getElementById('noticeList');

      // -------- 数据源：优先从 /json 取；失败则用内置示例 ----------
      async function getData(){
        try{
          const res = await fetch('../json/notification.json?ts=' + Date.now(), {cache:'no-store'});
          if(!res.ok) throw new Error(res.status);
          const data = await res.json();
          return Array.isArray(data.items) ? data.items : [];
        }catch(e){
          console.warn('读取 notification.json 失败，使用示例数据：', e);
          // 内置示例
          return [
            {
              id: '2024-10-01',
              date: '2024-10-01',
              title: '10/01 更新 · 读取notification失败,使用内置示例数据',
              summary: '读取notification失败,使用内置示例数据',
              detail: `
<p>本次更新包含：</p>
<ul class="changes">
  <li>读取notification失败,使用内置示例数据</li>
</ul>
              `
            }
          ];
        }
      }

      // -------- 工具：分组（按日期的 yyyy-mm-dd） ----------
      function groupByDate(items){
        const map = new Map();
        items.forEach(it=>{
          const k = (it.date || '').slice(0,10); // yyyy-mm-dd
          if(!map.has(k)) map.set(k, []);
          map.get(k).push(it);
        });
        // 新→旧
        return Array.from(map.entries()).sort((a,b)=> b[0].localeCompare(a[0]));
      }

      // -------- 渲染 ----------
      function render(items){
        if(!items.length){
          listEl.innerHTML = '<div class="date-sep">暂无通知</div>';
          return;
        }
        const groups = groupByDate(items);
        const frag = document.createDocumentFragment();

        groups.forEach(([date, arr])=>{
          const sep = document.createElement('div');
          sep.className = 'date-sep';
          sep.textContent = date;
          frag.appendChild(sep);

          arr.forEach(item=>{
            frag.appendChild(renderNotice(item));
          });
        });

        listEl.innerHTML = '';
        listEl.appendChild(frag);
      }

      function renderNotice(item){
        const wrap = document.createElement('section');
        wrap.className = 'notice';
        wrap.setAttribute('data-id', item.id || '');

        // 头部
        const head = document.createElement('div');
        head.className = 'notice-head';
        head.innerHTML = `
          <div class="notice-title">
            <div class="t-line">
              <span class="title">${escapeHtml(item.title || '更新')}</span>
              <span class="badge">${(item.badge || '更新').toString()}</span>
            </div>
            <div class="summary">${escapeHtml(item.summary || '')}</div>
            <div class="date">${escapeHtml((item.date || '').slice(0,16))}</div>
          </div>
          <div class="chevron">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
              <path d="M9 6l6 6-6 6" stroke="#ccc" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
        `;
        wrap.appendChild(head);

        // 内容
        const body = document.createElement('div');
        body.className = 'notice-body';
        const inner = document.createElement('div');
        inner.className = 'notice-content';
        inner.innerHTML = (item.detail || '').trim();
        body.appendChild(inner);
        wrap.appendChild(body);

        // 交互：展开/收起（带动画）
        head.addEventListener('click', ()=>{
          const open = wrap.classList.toggle('open');
          if(open){
            // 先清 0，再测量 scrollHeight 做动画
            body.style.maxHeight = '0px';
            requestAnimationFrame(()=>{
              body.style.maxHeight = inner.scrollHeight + 'px';
            });
          }else{
            body.style.maxHeight = body.clientHeight + 'px';
            requestAnimationFrame(()=>{
              body.style.maxHeight = '0px';
            });
          }
        });

        // 展开后内容高度变化（比如图片加载）需要同步调整 max-height
        const ro = new ResizeObserver(()=>{
          if(wrap.classList.contains('open')){
            body.style.maxHeight = inner.scrollHeight + 'px';
          }
        });
        ro.observe(inner);

        return wrap;
      }

      function escapeHtml(str){
        return String(str).replace(/[&<>"']/g, s=>({
          '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
        })[s]);
      }

      // 初始化
      getData().then(render);
    })();
  </script>
</body>
</html>
